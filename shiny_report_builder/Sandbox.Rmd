---
title: "Examples"
author: "Jean Dos Santos"
date: "21/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```





```{r}
run_optim <- function(target, vals, n_peaks = 5, seed=1, loss = loss_n_peak, init_params = NULL, lower = rep(0.0, 3*n_peaks), upper = rep(1000,3*n_peaks), method = "L-BFGS-B", maxit=500){

  set.seed(seed)
  if (is.null(init_params)) { init_params <- c(runif(n_peaks, 0, 500), runif(n_peaks, 5, 1000), runif(n_peaks, 1, 1000)) }
  
  optim_results <- optim(par = init_params,
                   fn = function(x) loss(x),
                   # target=y_test, 
                   # vals=x, 
                   # n_peaks = n_peaks,
                   lower = lower,
                   upper = upper,
                   method = method,
                   control = list(maxit = maxit)
                )
  
  
  solution = optim_results$par
  names(solution) <- c(paste0(rep("rel_area",n_peaks),1:n_peaks), paste0(rep("std_dev",n_peaks),1:n_peaks), paste0(rep("peak",5),1:n_peaks))
  
  optim_out <- list(solution = solution,
                    score = optim_results$value)
  
  return(optim_out)
}

res <- run_optim(target = y_pred, vals = bins, n_peaks = 3, loss = loss_n_peak)
res
```

```{r}
# loss_n_peak_exp <- function(x, x_target, y_target, n_peaks){
#   
#   tot_area_y_target <- pracma::trapz(vals, y_target)
#   elems_matrix <- matrix(data = rep(NA, n_peaks*length(y_target)), ncol = n_peaks)
#   
#   for (i in 1:n_peaks){
#     elems_matrix[,i] <- fit_peak(vals, center=x[(2*i)+2], sdt_dev=x[i+1], area =x[i])
#   }
# 
#   elems_total <- apply(elems_matrix, MARGIN = 1, sum, na.rm=FALSE)
#   tot_area_vec <- pracma::trapz(vals, elems_total)
#   
#   err <- sum((y_target - elems_total)^2)
#   
#   if (tot_area_vec > tot_area_y_target){
#     
#     return( Inf )
#     
#   } else { return(err) }
# }
```



```{r}
loss_n_peak(y_pred_params = y_test_params, x_target = bins, y_target = y_test, n_peaks = 3)
loss_n_peak(y_pred_params = y_test_params_actual, x_target = bins, y_target = y_test, n_peaks = 3)

tolerance <- 0.0000005
```


```{r}
options(scipen = 1) 
library(tictoc)


n_peaks = 3
lower_boundaries <- lower_ranges(x = bins, y = y_test, n_peaks = n_peaks, q_peak = 0.01)
upper_boundaries <- upper_ranges(x = bins, y = y_test, n_peaks = n_peaks, q_peak = 0.99)
# init_params <- optim_init_params(x = bins, y = y_test, n_peaks = n_peaks)
init_params <- c(rep(trapz(bins, y_test)/n_peaks,3), runif(n_peaks, 50, 1000), runif(n_peaks, 200, 900))
optim_init_params(x = bins, y = y_test, n_peaks = 3)

names(init_params) <- c(paste0(rep("rel_area",n_peaks),1:n_peaks), paste0(rep("std_dev",n_peaks),1:n_peaks), paste0(rep("peak",n_peaks),1:n_peaks))

optim_results <- optim(par = optim_init_params(x = bins, y = y_test, n_peaks = 3),
                       fn = loss_n_peak,
                       y_target = y_test,
                       x_target = bins,
                       n_peaks = n_peaks,
                       lower = lower_boundaries,
                       upper = upper_boundaries,
                       method = "L-BFGS-B",
                       control = list(maxit = 5000,
                                      factr = 0.00000001
                                      )
                       )

y_test_params
optim_results
```

```{r}
options(scipen = 999) 
library(tictoc)
library(DEoptim)

trapz(bins, y_test)

n_peaks = 3
lower_boundaries <- lower_ranges(x = bins, y = y_test, n_peaks = n_peaks, q_peak = 0.01)
upper_boundaries <- upper_ranges(x = bins, y = y_test, n_peaks = n_peaks, q_peak = 0.99)

DE_results <- DEoptim::DEoptim(fn = loss_n_peak_exp,
                      y_target = y_test,
                      x_target = bins,
                      n_peaks = n_peaks,
                      lower = lower_boundaries,
                      upper = upper_boundaries,
                      control = DEoptim.control(NP = 50, itermax = 5000, CR = 0.5, trace = 100, strategy=3)
                      )

DE_sol <- DE_results$optim$bestmem
DE_score <- DE_results$optim$bestval

DE_df <- solution_df <- process_solution(DE_sol)
plot_deconvoluted(solution_df=DE_df, x_vals=bins, y_vals=y_test)
```
```{r}
run_DE <- function(x_vals, target, n_peaks = 3, seed=1, loss = loss_n_peak_exp, maxit=1000, pop_size=100, p_crossover=0.5, strategy=3, verbosity=0){
  
  set.seed(seed)
  lower_boundaries <- lower_ranges(x = x_vals, y = target, n_peaks = n_peaks, q_peak = 0.01)
  upper_boundaries <- upper_ranges(x = x_vals, y = target, n_peaks = n_peaks, q_peak = 0.99)
  
  optim_results <- DEoptim::DEoptim(fn = loss,
                                    y_target = y_test,
                                    x_target = bins,
                                    n_peaks = n_peaks,
                                    lower = lower_boundaries,
                                    upper = upper_boundaries,
                                    control = DEoptim.control(NP = pop_size, itermax = maxit, CR = p_crossover, trace = verbosity*100, strategy=as.integer(strategy)))
  
  optim_out <- list(solution = optim_results$optim$bestmem,
                    score = optim_results$optim$bestval)
  
  return(optim_out)
}

sol <- run_DE(x_vals = bins, target = y_test, n_peaks = 3)
sol
```

```{r}
DE_df <- solution_df <- process_solution(sol_vec = DE_sol, x_vals = bins, names_vec = NULL)
plot_deconvoluted(solution_df=DE_df, x_vals=bins, y_vals=y_test)
plot_deconvoluted_poly(solution_df=DE_df, x_vals=bins, y_vals=y_test)


percentile_summary(x = bins, y = norm_cum_integral(x=bins, y=y_test), q = c(0.10,0.50,0.90,0.99))
```

```{r}
plot(bins, y_test, type="l")
lines(bins, solution_df$curve[[1]], type="l", col="green", lty=2)
lines(bins, solution_df$curve[[2]], type="l", col="red", lty=2)
lines(bins, solution_df$curve[[3]], type="l", col="blue", lty=2)
lines(bins, solution_df$curve[[1]]+solution_df$curve[[2]]+solution_df$curve[[3]], type="l", col="grey", lty=2)
```

```{r}
library(pracma)

solution_tbl_spr <- solution_df %>% 
  tidyr::unnest(cols=c("curve", "x_vals")) %>% 
  dplyr::select(ID, x_vals, curve) %>% 
  tidyr::spread(key="ID", value = "curve")
```







































